events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # Enable CORS for everything
    add_header Access-Control-Allow-Origin *;

    server {
        listen 80;
        
        # Frontend files
        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
        }
        
        # Media files (HLS)
        location /live/ {
            alias /usr/share/nginx/html/live/;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }

        # Health check
        location /api/health {
            proxy_pass http://watch-party-unch.zeabur.internal:8080/health;
            proxy_set_header Host $host;
        }

        # WebSocket Proxy - connects to the backend service
        # You must set the BACKEND_HOST environment variable or upstream in Zeabur
        location /ws {
            # In Zeabur, you'll use the internal DNS name of the backend service
            # For example: http://watchparty-backend:3000
            # We'll use a variable that we can substitute with envsubst if needed, 
            # but for now let's assume valid DNS or use a placeholder that matches Zeabur's pattern.
            # actually, standard nginx doesn't support env vars in proxy_pass without lua.
            # We will use the service name 'backend' which is common in internal networks 
            # or require the user to edit this. 
            # BETTER APPROACH: Zeabur services are often exposed on port 80 internally or their own port.
            
            # Proxy to the Backend Service using Zeabur Internal DNS
            proxy_pass http://watch-party-unch.zeabur.internal:8080; 
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_read_timeout 86400;
        }
    }
}
