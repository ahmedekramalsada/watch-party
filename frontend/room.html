<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party Room ğŸ¬</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* Lobby Overlay */
        #lobbyOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
        }

        #lobbyOverlay h1 {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .lobby-input {
            padding: 15px;
            font-size: 1.2em;
            border-radius: 8px;
            border: 1px solid #444;
            background: #222;
            color: white;
            margin-bottom: 20px;
            width: 250px;
            text-align: center;
        }

        .btn-join {
            padding: 15px 40px;
            font-size: 1.5em;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.5);
        }

        .btn-join:hover {
            transform: scale(1.1);
            background: #2ecc71;
        }

        /* Movie Selector & Custom Link */
        .movie-selector {
            margin: 15px auto;
            padding: 15px;
            background: rgba(42, 42, 42, 0.9);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .selector-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .movie-selector label {
            font-weight: bold;
            min-width: 80px;
            color: #ddd;
        }

        .movie-selector select,
        .movie-selector input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            border: 1px solid #444;
            font-size: 1em;
            outline: none;
        }

        .btn-play {
            padding: 10px 20px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-play:hover {
            background: #e67e22;
        }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            width: 100%;
        }

        .movie-info {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-top: 5px;
        }

        .movie-poster {
            width: 80px;
            border-radius: 4px;
            display: none;
        }

        /* Link Helper Modal */
        #linkHelperModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-content {
            background: #1e1e1e;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            border: 1px solid #444;
            color: white;
            position: relative;
        }

        .modal-content h2 {
            color: #f39c12;
            margin-top: 0;
        }

        .modal-content ol {
            padding-right: 20px;
            line-height: 1.6;
        }

        .modal-content kbd {
            background: #333;
            border: 1px solid #555;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .btn-close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
        }

        /* Library Management Modal */
        .management-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
        }

        .management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #222;
        }

        .management-item:last-child {
            border-bottom: none;
        }

        .btn-delete {
            background: #c0392b;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .btn-delete:hover {
            background: #e74c3c;
        }

        .management-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="room-page">

    <!-- LOBBY OVERLAY -->
    <div id="lobbyOverlay">
        <h1>ğŸ¬ Watch Party</h1>
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØºØ±ÙØ© <span id="lobbyRoomName">...</span></p>

        <input type="text" id="usernameInput" class="lobby-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">

        <button class="btn-join" onclick="joinRoom()">Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ© ğŸš€</button>
        <p style="margin-top: 10px; color: #888; font-size: 0.9em;">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡ (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©)</p>
    </div>

    <!-- MAIN APP -->
    <div class="room-container" id="appContainer" style="filter: blur(5px);">
        <!-- Video Section -->
        <div class="video-section">
            <div class="video-header">
                <h2>ØºØ±ÙØ©: <span id="roomName"></span></h2>
                <div class="users-count">
                    <span id="userCount">0</span> ğŸ‘¥
                </div>
            </div>

            <!-- Library & Custom Link -->
            <div class="movie-selector">
                <!-- Dropdown -->
                <div class="selector-row">
                    <label>ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø©:</label>
                    <select id="movieSelect" onchange="changeMovie()">
                        <option value="" disabled selected>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©...</option>
                    </select>
                </div>

                <div class="divider"></div>

                <!-- Custom Link -->
                <div class="selector-row">
                    <label>ğŸ”— Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ:</label>
                    <input type="text" id="customUrlInput" placeholder="https://example.com/video.mp4">
                    <button class="btn-play" onclick="playCustomLink()">ØªØ´ØºÙŠÙ„</button>
                </div>

                <div class="divider"></div>

                <!-- Web Download from main UI -->
                <div class="selector-row">
                    <label>ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ù…Ø®Ø²Ù†:</label>
                    <input type="text" id="mainWebDownloadUrl" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ­Ù…ÙŠÙ„...">
                    <button class="btn-play" style="background: #27ae60;" onclick="mainWebDownload()">ØªØ­Ù…ÙŠÙ„ ğŸ’¾</button>
                    <button class="btn-play" style="background: #3498db;" onclick="openLibraryManager()">âš™ï¸
                        Ø¥Ø¯Ø§Ø±Ø©</button>
                </div>

                <!-- Info Display -->
                <div class="movie-info" id="movieInfo">
                    <img id="posterImg" class="movie-poster" src="" alt="Poster">
                    <div style="flex-grow: 1;">
                        <h3 id="currentTitle" style="margin: 0;">Ø§Ø®ØªØ± ÙÙŠÙ„Ù…Ø§Ù‹</h3>
                        <p id="currentUrl" style="font-size: 0.8em; color: #aaa; word-break: break-all;"></p>
                    </div>
                </div>
            </div>

            <div class="video-wrapper">
                <video id="video" controls playsinline referrerpolicy="no-referrer"></video>
                <div class="sync-indicator" id="syncIndicator">
                    ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...
                </div>
            </div>

            <div class="video-controls">
                <button class="btn btn-small" onclick="forceSync()">âš¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©</button>
                <button class="btn btn-small" onclick="copyRoomLink()">ğŸ“‹ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©</button>
                <button class="btn btn-small" onclick="openLibraryManager()">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>
                <button class="btn btn-small btn-danger" onclick="leaveRoom()">ğŸšª Ù…ØºØ§Ø¯Ø±Ø©</button>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <h3>ğŸ’¬ Ø§Ù„Ø´Ø§Øª</h3>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
                    onkeypress="handleMessageKeypress(event)">
                <button class="btn btn-primary" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„ ğŸ“¤</button>
            </div>
        </div>
    </div>
    </div>

    <!-- LIBRARY MANAGEMENT MODAL -->
    <div id="libraryManageModal"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;">
        <div class="modal-content">
            <button class="btn-close-modal" onclick="closeLibraryManager()">Ã—</button>
            <h2>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©</h2>

            <h3>ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯</h3>
            <div class="management-input-group">
                <input type="text" id="webDownloadUrl" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‡Ù†Ø§..." style="flex: 2;">
                <input type="text" id="webDownloadTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠÙ„Ù…" style="flex: 1;">
                <button class="btn btn-primary" onclick="webDownloadVideo()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„</button>
            </div>

            <h3>ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø©</h3>
            <div id="managementList" class="management-list">
                <!-- Items will be populated here -->
            </div>
        </div>
    </div>

    <!-- LINK HELPER MODAL -->
    <div id="linkHelperModal">
        <div class="modal-content">
            <button class="btn-close-modal" onclick="closeLinkHelper()">Ã—</button>
            <h2>ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©</h2>
            <p>ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ù‚Ù…Øª Ø¨Ù†Ø³Ø® Ø±Ø§Ø¨Ø· <strong>ØµÙØ­Ø© ÙˆÙŠØ¨</strong> Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø±Ø§Ø¨Ø· <strong>Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</strong>. Ø§Ù„Ù…Ø´ØºÙ„
                ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ (.mp4) Ø£Ùˆ (.m3u8).</p>

            <h3>ÙƒÙŠÙ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŸ</h3>
            <ol>
                <li>Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ù…ØªØµÙØ­Ùƒ.</li>
                <li>Ø§Ø¶ØºØ· Ø¨ÙŠÙ…ÙŠÙ† Ø§Ù„Ù…Ø§ÙˆØ³ ÙˆØ§Ø®ØªØ± <strong>Inspect (ÙØ­Øµ)</strong> Ø£Ùˆ Ø§Ø¶ØºØ· <kbd>F12</kbd>.</li>
                <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ <strong>Network (Ø§Ù„Ø´Ø¨ÙƒØ©)</strong>.</li>
                <li>Ø§Ø¨Ø­Ø« ÙÙŠ Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† <code>m3u8</code> Ø£Ùˆ <code>mp4</code>.</li>
                <li>Ù‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.</li>
                <li>Ø§Ø¶ØºØ· Ø¨ÙŠÙ…ÙŠÙ† Ø§Ù„Ù…Ø§ÙˆØ³ Ø¹Ù„ÙŠÙ‡ ÙˆØ§Ø®ØªØ± <strong>Copy link address</strong>.</li>
            </ol>
            <button class="btn btn-primary" style="width: 100%;" onclick="closeLinkHelper()">ÙÙ‡Ù…ØªØŒ Ø³Ø£Ø¨Ø­Ø« Ø¹Ù†
                Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        let username = urlParams.get('username');

        if (!roomId) {
            alert('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            window.location.href = 'index.html';
        }

        document.getElementById('roomName').textContent = roomId;
        document.getElementById('lobbyRoomName').textContent = roomId;

        // Setup Logic for Username
        const usernameInput = document.getElementById('usernameInput');
        if (username) {
            usernameInput.value = username;
        }

        const video = document.getElementById('video');
        const chatMessages = document.getElementById('chatMessages');
        const syncIndicator = document.getElementById('syncIndicator');
        const movieSelect = document.getElementById('movieSelect');
        const customUrlInput = document.getElementById('customUrlInput');
        const posterImg = document.getElementById('posterImg');

        let ws;
        let isConnected = false;
        let isSyncing = false;
        let isBuffering = false;
        let hls;
        let currentMovie = null;
        let pendingMovieId = null;
        let retryCount = 0;

        // --- LOBBY LOGIC ---
        function joinRoom() {
            const nameVal = usernameInput.value.trim();
            if (!nameVal) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ");
                return;
            }
            username = nameVal;

            // Unlock Audio Context
            const overlay = document.getElementById('lobbyOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 500);
            document.getElementById('appContainer').style.filter = 'none';

            // Connect
            connectWebSocket();
        }

        // --- PLAYER LOGIC ---
        function loadVideo(movie) {
            if (currentMovie && currentMovie.url === movie.url) return;

            currentMovie = movie;
            const url = movie.url;
            console.log('Loading:', url);
            retryCount = 0;

            document.getElementById('currentTitle').textContent = movie.name;
            document.getElementById('currentUrl').textContent = url;
            if (movie.poster) {
                posterImg.src = movie.poster;
                posterImg.style.display = 'block';
            } else {
                posterImg.style.display = 'none';
            }

            // Reset Inputs
            if (movie.type === 'catalog') {
                syncDropdown(movie.id);
                customUrlInput.value = '';
            } else {
                movieSelect.selectedIndex = -1;
                customUrlInput.value = movie.url;
            }

            const isHLS = url.toLowerCase().includes('.m3u8') || url.toLowerCase().includes('master.m3u8') || url.toLowerCase().includes('playlist.m3u8');

            if (Hls.isSupported() && isHLS) {
                video.removeAttribute('crossorigin');
                if (hls) hls.destroy();
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                    xhrSetup: function (xhr, url) {
                        xhr.withCredentials = false;
                    }
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log('Manifest loaded');
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('HLS Fatal Error:', data.type);
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                showSyncIndicator('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù†ØªÙ‡ÙŠ Ø£Ùˆ Ù…Ø­Ù…ÙŠ)');
                                reportPlaybackError(`HLS Network Error (${data.details})`);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                showSyncIndicator('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‚Ø·Ø¹');
                                hls.recoverMediaError();
                                break;
                            default:
                                showSyncIndicator('âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·');
                                reportPlaybackError(`HLS Error (${data.type})`);
                                hls.destroy();
                                break;
                        }
                    }
                });
            } else {
                if (hls) { hls.destroy(); hls = null; }
                video.removeAttribute('crossorigin');
                video.src = url;
            }
        }

        function reportPlaybackError(errorType) {
            if (isConnected) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    message: `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯ÙŠ (${errorType}).`
                }));
            }
        }

        video.onerror = () => {
            if (video.src && video.src !== window.location.href) {
                let errDetail = "Unknown Error";
                if (video.error) {
                    switch (video.error.code) {
                        case 1: errDetail = "Aborted"; break;
                        case 2: errDetail = "Network Error"; break;
                        case 3: errDetail = "Decode Error"; break;
                        case 4: errDetail = "Source Not Supported / Access Denied"; break;
                    }
                }
                console.error("Native Video Error:", errDetail, video.error);

                if (!video.getAttribute('crossorigin') && retryCount < 1) {
                    console.log("Retrying with CORS anonymous...");
                    retryCount++;
                    video.setAttribute('crossorigin', 'anonymous');
                    video.load();
                    return;
                }

                showSyncIndicator('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø­Ù…ÙŠ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ)');
                reportPlaybackError(errDetail);
            }
        };

        function syncDropdown(id) {
            for (let i = 0; i < movieSelect.options.length; i++) {
                try {
                    const val = movieSelect.options[i].value;
                    if (!val) continue;
                    const m = JSON.parse(val);
                    if (m.id === id) {
                        movieSelect.selectedIndex = i;
                        return;
                    }
                } catch (e) { }
            }
            pendingMovieId = id;
        }

        // --- CATALOG LOGIC ---
        async function loadCatalog() {
            try {
                const response = await fetch('/live/catalog.json');
                if (!response.ok) throw new Error('Failed to load catalog');
                const uniqueCatalog = await response.json();

                movieSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© --</option>';

                uniqueCatalog.forEach(cat => {
                    const group = document.createElement('optgroup');
                    group.label = cat.category;
                    cat.items.forEach(movie => {
                        const m = { ...movie, type: 'catalog' };
                        const option = document.createElement('option');
                        option.value = JSON.stringify(m);
                        option.text = movie.name;
                        group.appendChild(option);
                    });
                    movieSelect.add(group);
                });

                if (pendingMovieId) {
                    syncDropdown(pendingMovieId);
                    pendingMovieId = null;
                }

            } catch (err) {
                console.error(err);
                movieSelect.innerHTML = '<option>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©</option>';
            }
        }

        loadCatalog();

        function changeMovie() {
            if (!isConnected) return;
            try {
                const movie = JSON.parse(movieSelect.value);
                ws.send(JSON.stringify({ type: 'change-movie', movie }));
            } catch (e) { }
        }

        function playCustomLink() {
            if (!isConnected) return;
            const url = customUrlInput.value.trim();
            if (!url) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·");

            // Webpage detection
            const isWebpage = !url.toLowerCase().split('?')[0].match(/\.(mp4|m3u8|mkv|mov|avi)$/) &&
                (url.includes('.html') || url.includes('.php') || !url.includes('.'));

            if (isWebpage) {
                showSyncIndicator('âœ¨ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§...');
                ws.send(JSON.stringify({ type: 'resolve-url', url: url }));
                return;
            }

            const movie = {
                type: 'url',
                url: url,
                name: 'Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ ğŸ”—',
                id: 'custom-' + Date.now()
            };
            ws.send(JSON.stringify({ type: 'change-movie', movie }));
        }

        function closeLinkHelper() {
            document.getElementById('linkHelperModal').style.display = 'none';
        }

        // --- WEBSOCKET ---
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                isConnected = true;
                ws.send(JSON.stringify({ type: 'join', roomId, username }));
                addSystemMessage('ğŸŸ¢ Ù…ØªØµÙ„ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            ws.onclose = () => {
                isConnected = false;
                setTimeout(connectWebSocket, 3000);
            };
        }

        function handleMessage(data) {
            switch (data.type) {
                case 'state':
                    if (data.currentMovie) {
                        loadVideo(data.currentMovie);
                    }
                    syncVideo(data);
                    break;
                case 'movie-changed':
                    addSystemMessage(`ğŸ¬ ${data.username} Ø´ØºÙ„: ${data.movie.name}`);
                    loadVideo(data.movie);
                    break;
                case 'error':
                    showSyncIndicator(`âŒ ${data.message}`);
                    document.getElementById('linkHelperModal').style.display = 'flex';
                    break;
                case 'sync':
                    if (!isBuffering) syncVideo(data);
                    break;
                case 'force-sync':
                    isSyncing = true;
                    video.currentTime = data.time;
                    if (data.action === 'play') video.play().catch(() => { });
                    else video.pause();
                    setTimeout(() => isSyncing = false, 1000);
                    showSyncIndicator(`âš¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ù…Ù† ${data.username}`);
                    break;
                case 'buffering':
                    if (data.action === 'start') {
                        isBuffering = true;
                        video.pause();
                        showSyncIndicator(`â³ ${data.username} ÙŠÙˆØ§Ø¬Ù‡ Ø¨Ø·Ø¦Ø§Ù‹...`);
                    } else {
                        isBuffering = false;
                        video.play().catch(() => { });
                        showSyncIndicator(`â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù`);
                    }
                    break;
                case 'seek':
                    isSyncing = true;
                    video.currentTime = data.time;
                    setTimeout(() => isSyncing = false, 500);
                    showSyncIndicator(`${data.username} â©`);
                    break;
                case 'chat':
                    addChatMessage(data.username, data.message);
                    break;
                case 'user-joined':
                    updateUserCount(data.userCount);
                    addSystemMessage(`${data.username} Ø§Ù†Ø¶Ù… ğŸ‘‹`);
                    break;
                case 'user-left':
                    updateUserCount(data.userCount);
                    addSystemMessage(`${data.username} ØºØ§Ø¯Ø± ğŸ‘‹`);
                    break;
                case 'library-updated':
                    loadCatalog();
                    break;
            }
        }

        function syncVideo(data) {
            const diff = Math.abs(video.currentTime - data.time);
            if (diff > 2) video.currentTime = data.time;

            if (data.action === 'play' && video.paused) {
                video.play().catch(e => console.log('Autoplay:', e));
            } else if (data.action === 'pause' && !video.paused) {
                video.pause();
            }
        }

        let syncTimeout;
        function showSyncIndicator(msg) {
            if (syncTimeout) clearTimeout(syncTimeout);

            syncIndicator.textContent = msg;
            syncIndicator.style.display = 'block';

            syncTimeout = setTimeout(() => {
                syncIndicator.style.display = 'none';
            }, 4000); // 4 seconds timeout
        }

        // --- EVENTS ---
        video.onplay = () => sendSync('play');
        video.onpause = () => sendSync('pause');
        video.onseeked = () => {
            if (!isSyncing && isConnected) {
                ws.send(JSON.stringify({ type: 'seek', time: video.currentTime }));
            }
        };

        // Buffering Events
        let bufferTimeout;
        video.onwaiting = () => {
            if (isConnected && !isBuffering) {
                // Debounce slightly to avoid flicker
                bufferTimeout = setTimeout(() => {
                    ws.send(JSON.stringify({ type: 'buffering', action: 'start' }));
                }, 500);
            }
        };

        video.onplaying = () => {
            if (bufferTimeout) clearTimeout(bufferTimeout);
            if (isConnected && isBuffering) {
                // We were buffering, now we are good
                ws.send(JSON.stringify({ type: 'buffering', action: 'end' }));
            }
        };

        function sendSync(action) {
            if (!isSyncing && isConnected && !isBuffering) {
                ws.send(JSON.stringify({
                    type: 'sync', action, time: video.currentTime
                }));
            }
        }

        function forceSync() {
            if (!isConnected) return;
            const action = video.paused ? 'pause' : 'play';
            ws.send(JSON.stringify({
                type: 'force-sync',
                time: video.currentTime,
                action: action
            }));
            showSyncIndicator('âš¡ ØªÙ… ÙØ±Ø¶ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
        }

        // --- UTILS ---
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const msg = input.value.trim();
            if (msg && isConnected) {
                ws.send(JSON.stringify({ type: 'chat', message: msg }));
                addChatMessage(username, msg, true);
                input.value = '';
            }
        }
        function handleMessageKeypress(e) { if (e.key === 'Enter') sendMessage(); }

        function addChatMessage(user, msg, own = false) {
            const div = document.createElement('div');
            div.className = `chat-message ${own ? 'own-message' : ''}`;
            div.innerHTML = `<span class="message-user">${user}:</span> <span class="message-text">${msg}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        function addSystemMessage(msg) {
            const div = document.createElement('div');
            div.className = 'chat-message system-message';
            div.innerText = msg;
            chatMessages.appendChild(div);
        }
        function updateUserCount(n) { document.getElementById('userCount').innerText = n; }

        function copyRoomLink() {
            const cleanUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            navigator.clipboard.writeText(cleanUrl);
            alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! (Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…Ùƒ) ğŸ“‹');
        }

        function openLibraryManager() {
            document.getElementById('libraryManageModal').style.display = 'flex';
            populateManagementList();
        }

        function closeLibraryManager() {
            document.getElementById('libraryManageModal').style.display = 'none';
        }

        async function populateManagementList() {
            const list = document.getElementById('managementList');
            list.innerHTML = '<p style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

            try {
                const response = await fetch('/live/catalog.json');
                const catalog = await response.json();
                list.innerHTML = '';

                catalog.forEach(cat => {
                    cat.items.forEach(movie => {
                        const div = document.createElement('div');
                        div.className = 'management-item';
                        div.innerHTML = `
                            <span>${movie.name} <small style="color: #666;">(${cat.category})</small></span>
                            <button class="btn-delete" onclick="webDeleteMovie('${movie.id}')">Ø­Ø°Ù</button>
                        `;
                        list.appendChild(div);
                    });
                });

                if (list.innerHTML === '') {
                    list.innerHTML = '<p style="text-align: center; color: #888;">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©</p>';
                }
            } catch (e) {
                list.innerHTML = '<p style="text-align: center; color: #e74c3c;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>';
            }
        }

        function webDownloadVideo() {
            const url = document.getElementById('webDownloadUrl').value.trim();
            const title = document.getElementById('webDownloadTitle').value.trim();

            if (!url) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·');

            ws.send(JSON.stringify({
                type: 'web-download',
                url: url,
                title: title
            }));

            alert('ØªÙ… Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©. Ø³ØªØµÙ„Ùƒ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.');
            closeLibraryManager();
            document.getElementById('webDownloadUrl').value = '';
            document.getElementById('webDownloadTitle').value = '';
        }

        function webDeleteMovie(movieId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙÙŠÙ„Ù…ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©.')) return;

            console.log('Requesting delete for:', movieId);
            ws.send(JSON.stringify({
                type: 'web-delete',
                movieId: movieId
            }));

            // UI feedback
            showSyncIndicator('ğŸ—‘ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
            setTimeout(populateManagementList, 1000);
        }

        function mainWebDownload() {
            const url = document.getElementById('mainWebDownloadUrl').value.trim();
            if (!url) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·');

            ws.send(JSON.stringify({
                type: 'web-download',
                url: url,
                title: ''
            }));

            showSyncIndicator('ğŸ“¥ Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©...');
            document.getElementById('mainWebDownloadUrl').value = '';
        }

        function leaveRoom() { location.href = 'index.html'; }
    </script>
</body>

</html>