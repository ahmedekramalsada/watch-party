<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party Room ğŸ¬</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        .movie-selector {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .movie-selector select {
            flex-grow: 1;
            padding: 8px;
            border-radius: 4px;
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
        }
    </style>
</head>

<body class="room-page">
    <div class="room-container">
        <!-- Video Section -->
        <div class="video-section">
            <div class="video-header">
                <h2 id="roomTitle">ØºØ±ÙØ©: <span id="roomName"></span></h2>
                <div class="users-count">
                    <span id="userCount">0</span> ğŸ‘¥
                </div>
            </div>

            <!-- Movie Selector -->
            <div class="movie-selector">
                <label>ğŸ¬ Ø§Ù„ÙÙŠÙ„Ù…:</label>
                <select id="movieSelect" onchange="changeMovie()">
                    <option value="" disabled selected>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</option>
                </select>
            </div>

            <div class="video-wrapper">
                <video id="video" controls autoplay></video>
                <div class="sync-indicator" id="syncIndicator">
                    ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...
                </div>
            </div>
            <div class="video-controls">
                <button class="btn btn-small" onclick="copyRoomLink()">ğŸ“‹ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©</button>
                <button class="btn btn-small btn-danger" onclick="leaveRoom()">ğŸšª Ù…ØºØ§Ø¯Ø±Ø©</button>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <h3>ğŸ’¬ Ø§Ù„Ø´Ø§Øª</h3>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
                    onkeypress="handleMessageKeypress(event)">
                <button class="btn btn-primary" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const username = urlParams.get('username');

        if (!roomId || !username) {
            alert('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            window.location.href = 'index.html';
        }

        document.getElementById('roomName').textContent = roomId;

        const video = document.getElementById('video');
        const chatMessages = document.getElementById('chatMessages');
        const syncIndicator = document.getElementById('syncIndicator');
        const movieSelect = document.getElementById('movieSelect');

        let ws;
        let isConnected = false;
        let isSyncing = false;
        let hls;
        let currentMoviePath = '';
        let pendingMovieId = null;

        // Initialize HLS
        function loadVideo(path) {
            if (path === currentMoviePath) return; // Don't reload if same

            currentMoviePath = path;
            const fullPath = `/live/${path}`;
            console.log('Loading video:', fullPath);

            if (Hls.isSupported()) {
                if (hls) hls.destroy(); // Destroy previous instance

                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true,
                });
                hls.loadSource(fullPath);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log('HLS manifest loaded');
                    addSystemMessage('Ø§Ù„ÙÙŠÙ„Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„ ğŸ¬');
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('HLS error:', data);
                        addSystemMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠÙ„Ù… attempt to recover...');
                        hls.startLoad();
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = fullPath;
            }
        }

        // Fetch Catalog
        async function loadCatalog() {
            try {
                const response = await fetch('/live/catalog.json');
                if (!response.ok) throw new Error('Failed to load catalog');
                const catalog = await response.json();

                movieSelect.innerHTML = '';
                if (catalog.length === 0) {
                    const option = document.createElement('option');
                    option.text = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙÙ„Ø§Ù… Ù…ØªØ§Ø­Ø©";
                    movieSelect.add(option);
                    return;
                }

                catalog.forEach(movie => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(movie); // Store full object
                    option.text = movie.name;
                    movieSelect.add(option);
                });

                // Apply pending movie if exists (from server state)
                if (pendingMovieId) {
                    updateSelector(pendingMovieId);
                    // Also load the video if not loaded yet
                    const pendingMovie = catalog.find(m => m.id === pendingMovieId);
                    if (pendingMovie) {
                        loadVideo(pendingMovie.path);
                    }
                    pendingMovieId = null;
                }
                // Default to first movie if no state from server yet and nothing selected
                else if (!currentMoviePath && catalog.length > 0) {
                    const firstMovie = catalog[0];
                    loadVideo(firstMovie.path);
                    // We select it in dropdown but DON'T send change-movie to server
                    // This creates a local defaults without overwriting other users
                    updateSelector(firstMovie.id);
                }

            } catch (err) {
                console.error('Error loading catalog:', err);
                movieSelect.innerHTML = '<option>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>';
            }
        }

        loadCatalog();

        function changeMovie() {
            if (!isConnected) return;
            try {
                const selectedMovie = JSON.parse(movieSelect.value);
                ws.send(JSON.stringify({
                    type: 'change-movie',
                    movie: selectedMovie
                }));
            } catch (e) { console.error(e); }
        }

        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                isConnected = true;
                ws.send(JSON.stringify({
                    type: 'join',
                    roomId: roomId,
                    username: username
                }));
                addSystemMessage('Ø§Ù†Øª Ø¯Ù„ÙˆÙ‚ØªÙŠ Ù…ØªØµÙ„! ğŸ‰');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                isConnected = false;
                addSystemMessage('Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù†Ù‚Ø·Ø¹ - Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'state':
                    if (data.currentMovie) {
                        loadVideo(data.currentMovie.path);
                        updateSelector(data.currentMovie.id);
                    } else {
                        // If null state, we depend on loadCatalog logic to pick default
                    }
                    syncVideoState(data);
                    break;

                case 'movie-changed':
                    addSystemMessage(`ğŸ¬ ${data.username} ØºÙŠØ± Ø§Ù„ÙÙŠÙ„Ù… Ø¥Ù„Ù‰: ${data.movie.name}`);
                    loadVideo(data.movie.path);
                    updateSelector(data.movie.id);
                    break;

                case 'sync':
                    if (data.username !== username) {
                        showSyncIndicator(`${data.username} Ù‚Ø§Ù… Ø¨Ù€ ${data.action === 'play' ? 'ØªØ´ØºÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ø§Ù„ÙÙŠØ¯ÙŠÙˆ`);
                        syncVideoState(data);
                    }
                    break;

                case 'seek':
                    if (data.username !== username) {
                        showSyncIndicator(`${data.username} Ù‚ÙØ² Ù„Ù„Ø«Ø§Ù†ÙŠØ© ${Math.floor(data.time)}`);
                        isSyncing = true;
                        video.currentTime = data.time;
                        setTimeout(() => isSyncing = false, 500);
                    }
                    break;

                case 'chat':
                    addChatMessage(data.username, data.message);
                    break;

                case 'user-joined':
                    addSystemMessage(`${data.username} Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ© ğŸ‘‹`);
                    updateUserCount(data.userCount);
                    break;

                case 'user-left':
                    addSystemMessage(`${data.username} ØºØ§Ø¯Ø± Ø§Ù„ØºØ±ÙØ© ğŸ‘‹`);
                    updateUserCount(data.userCount);
                    break;
            }
        }

        function updateSelector(movieId) {
            let found = false;
            // Find option with this movie ID and select it
            for (let i = 0; i < movieSelect.options.length; i++) {
                try {
                    // Check if value is valid JSON
                    if (!movieSelect.options[i].value) continue;

                    const movie = JSON.parse(movieSelect.options[i].value);
                    if (movie.id === movieId) {
                        movieSelect.selectedIndex = i;
                        found = true;
                        break;
                    }
                } catch (e) { }
            }

            if (!found) {
                pendingMovieId = movieId;
            }
        }

        function syncVideoState(data) {
            isSyncing = true;

            const timeDiff = Math.abs(video.currentTime - data.time);
            if (timeDiff > 2) {
                video.currentTime = data.time;
            }

            if (data.action === 'play' && video.paused) {
                video.play().catch(e => console.log('Autoplay prevented:', e));
            } else if (data.action === 'pause' && !video.paused) {
                video.pause();
            }

            setTimeout(() => isSyncing = false, 500);
        }

        function showSyncIndicator(message) {
            syncIndicator.textContent = message;
            syncIndicator.style.display = 'block';
            setTimeout(() => {
                syncIndicator.style.display = 'none';
            }, 2000);
        }

        // Video event listeners
        video.addEventListener('play', () => {
            if (!isSyncing && isConnected) {
                ws.send(JSON.stringify({
                    type: 'sync',
                    action: 'play',
                    time: video.currentTime
                }));
            }
        });

        video.addEventListener('pause', () => {
            if (!isSyncing && isConnected) {
                ws.send(JSON.stringify({
                    type: 'sync',
                    action: 'pause',
                    time: video.currentTime
                }));
            }
        });

        video.addEventListener('seeked', () => {
            if (!isSyncing && isConnected) {
                ws.send(JSON.stringify({
                    type: 'seek',
                    time: video.currentTime
                }));
            }
        });

        // Chat functions
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message && isConnected) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    message: message
                }));
                addChatMessage(username + ' (Ø£Ù†Øª)', message, true);
                input.value = '';
            }
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addChatMessage(user, message, isOwn = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isOwn ? 'own-message' : ''}`;
            messageDiv.innerHTML = `
                <span class="message-user">${user}:</span>
                <span class="message-text">${escapeHtml(message)}</span>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message system-message';
            messageDiv.innerHTML = `<span class="message-text">${message}</span>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateUserCount(count) {
            document.getElementById('userCount').textContent = count;
        }

        function copyRoomLink() {
            const link = window.location.href;
            navigator.clipboard.writeText(link).then(() => {
                alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ğŸ‰');
            });
        }

        function leaveRoom() {
            if (confirm('Ù…ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¹Ø§ÙŠØ² ØªØ³ÙŠØ¨ Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                ws.close();
                window.location.href = 'index.html';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        connectWebSocket();
    </script>
</body>

</html>