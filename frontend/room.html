<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Party Room ğŸ¬</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        .movie-selector {
            margin: 15px auto;
            padding: 15px;
            background: rgba(42, 42, 42, 0.9);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .selector-row {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .movie-selector label {
            white-space: nowrap;
            font-weight: bold;
            color: #ddd;
            min-width: 80px;
        }

        .movie-selector select,
        .movie-selector input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 6px;
            background: #1a1a1a;
            color: white;
            border: 1px solid #444;
            max-width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }

        .movie-selector select:hover,
        .movie-selector input:focus {
            border-color: #f39c12;
        }

        .btn-play {
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-play:hover {
            background: #e67e22;
        }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            width: 100%;
            margin: 5px 0;
        }
    </style>
</head>

<body class="room-page">
    <div class="room-container">
        <!-- Video Section -->
        <div class="video-section">
            <div class="video-header">
                <h2 id="roomTitle">ØºØ±ÙØ©: <span id="roomName"></span></h2>
                <div class="users-count">
                    <span id="userCount">0</span> ğŸ‘¥
                </div>
            </div>

            <!-- Enhanced Movie Selector -->
            <div class="movie-selector">
                <!-- Dropdown -->
                <div class="selector-row">
                    <label>ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø©:</label>
                    <select id="movieSelect" onchange="changeCatalogMovie()">
                        <option value="" disabled selected>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©...</option>
                    </select>
                </div>

                <div class="divider"></div>

                <!-- Direct Link -->
                <div class="selector-row">
                    <label>ğŸ”— Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±:</label>
                    <input type="text" id="directLinkInput" placeholder="https://example.com/video.mp4">
                    <button class="btn-play" onclick="playDirectLink()">ØªØ´ØºÙŠÙ„</button>
                </div>
            </div>

            <div class="video-wrapper">
                <video id="video" controls autoplay playsinline></video>
                <div class="sync-indicator" id="syncIndicator">
                    ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...
                </div>
            </div>
            <div class="video-controls">
                <button class="btn btn-small" onclick="copyRoomLink()">ğŸ“‹ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ©</button>
                <button class="btn btn-small btn-danger" onclick="leaveRoom()">ğŸšª Ù…ØºØ§Ø¯Ø±Ø©</button>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div class="chat-header">
                <h3>ğŸ’¬ Ø§Ù„Ø´Ø§Øª</h3>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
                    onkeypress="handleMessageKeypress(event)">
                <button class="btn btn-primary" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const username = urlParams.get('username');

        if (!roomId || !username) {
            alert('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            window.location.href = 'index.html';
        }

        document.getElementById('roomName').textContent = roomId;

        const video = document.getElementById('video');
        const chatMessages = document.getElementById('chatMessages');
        const syncIndicator = document.getElementById('syncIndicator');
        const movieSelect = document.getElementById('movieSelect');
        const directLinkInput = document.getElementById('directLinkInput');

        let ws;
        let isConnected = false;
        let isSyncing = false;
        let hls;
        let currentMovieSource = null; // Object { type: 'catalog'|'url', ... }
        let pendingMovieId = null;

        // Initialize Player logic
        function loadVideoSource(movie) {
            if (currentMovieSource && currentMovieSource.type === movie.type && currentMovieSource.path === movie.path && currentMovieSource.url === movie.url) {
                return; // Prevent reload if same content
            }

            currentMovieSource = movie;
            let videoUrl = '';

            if (movie.type === 'catalog') {
                videoUrl = `/live/${movie.path}`;
                directLinkInput.value = ''; // Clear URL input
                // Try to sync UI immediately
                if (!selectCatalogMovieById(movie.id)) {
                    console.log('Catalog item not found in UI yet, pending:', movie.id);
                    pendingMovieId = movie.id;
                }
            } else if (movie.type === 'url') {
                videoUrl = movie.url;
                movieSelect.selectedIndex = -1; // Deselect catalog
                directLinkInput.value = movie.url; // Sync UI
            }

            console.log('Loading video:', videoUrl);

            // Determine if HLS or direct
            const isHLS = videoUrl.includes('.m3u8');

            if (Hls.isSupported() && isHLS) {
                if (hls) hls.destroy();
                hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.loadSource(videoUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    addSystemMessage(`ØªÙ… ØªØ´ØºÙŠÙ„: ${movie.name} ğŸ¬`);
                });
                hls.on(Hls.Events.ERROR, (e, data) => handleHlsError(data));
            } else {
                if (hls) { hls.destroy(); hls = null; }
                video.src = videoUrl;
                addSystemMessage(`ØªÙ… ØªØ´ØºÙŠÙ„: ${movie.name} ğŸ¬`);
            }
        }

        function handleHlsError(data) {
            if (data.fatal) {
                console.error('HLS error:', data);
                if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                    addSystemMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© - ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ø§Ù„ÙƒÙˆØ±Ø³ (CORS)');
                } else {
                    hls.startLoad();
                }
            }
        }

        // --- Catalog Logic ---
        async function loadCatalog() {
            try {
                const response = await fetch('/live/catalog.json');
                if (!response.ok) throw new Error('Failed');
                const catalog = await response.json();

                movieSelect.innerHTML = '';
                if (catalog.length === 0) {
                    const option = document.createElement('option');
                    option.text = "Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©";
                    movieSelect.add(option);
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.text = "-- Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø© --";
                    defaultOption.value = "";
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    movieSelect.add(defaultOption);

                    catalog.forEach(item => {
                        const movie = { ...item, type: 'catalog' };
                        const option = document.createElement('option');
                        option.value = JSON.stringify(movie);
                        option.text = movie.name;
                        movieSelect.add(option);
                    });
                }

                // If pending ID exists from server state 
                if (pendingMovieId) {
                    selectCatalogMovieById(pendingMovieId);
                    pendingMovieId = null;
                }
                // If no server state yet (e.g. fresh room), load defaults
                else if (!currentMovieSource && catalog.length > 0) {
                    const firstMovie = { ...catalog[0], type: 'catalog' };
                    // Play it locally (don't broadcast yet)
                    loadVideoSource(firstMovie);
                }

            } catch (err) {
                console.error(err);
                movieSelect.innerHTML = '<option>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>';
            }
        }

        function selectCatalogMovieById(id) {
            for (let i = 0; i < movieSelect.options.length; i++) {
                try {
                    const val = movieSelect.options[i].value;
                    if (!val) continue;
                    const movie = JSON.parse(val);
                    if (movie.id === id) {
                        movieSelect.selectedIndex = i;
                        return true; // Found and selected
                    }
                } catch (e) { }
            }
            return false; // Not found
        }

        loadCatalog();

        // --- User Actions ---

        function changeCatalogMovie() {
            if (!isConnected) return;
            try {
                const selectedMovie = JSON.parse(movieSelect.value);
                ws.send(JSON.stringify({
                    type: 'change-movie',
                    movie: selectedMovie
                }));
            } catch (e) { }
        }

        function playDirectLink() {
            if (!isConnected) return;
            const url = directLinkInput.value.trim();
            if (!url) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø·');

            const movie = {
                type: 'url',
                url: url,
                name: 'ÙÙŠØ¯ÙŠÙˆ Ø®Ø§Ø±Ø¬ÙŠ ğŸ”—',
                id: 'url-' + Date.now()
            };

            ws.send(JSON.stringify({
                type: 'change-movie',
                movie: movie
            }));
        }

        // --- WebSocket ---
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log('Connected');
                isConnected = true;
                ws.send(JSON.stringify({ type: 'join', roomId, username }));
                addSystemMessage('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸŸ¢');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                isConnected = false;
                addSystemMessage('ğŸ”´ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'state':
                    if (data.currentMovie) {
                        loadVideoSource(data.currentMovie);
                    } else {
                        // If no movie selected by server, maybe hint user
                    }
                    syncVideoState(data);
                    break;

                case 'movie-changed':
                    addSystemMessage(`ğŸ¬ ${data.username} Ø´ØºÙ„: ${data.movie.name}`);
                    loadVideoSource(data.movie);
                    break;

                case 'sync':
                    if (data.username !== username) {
                        showSyncIndicator(`${data.username} ${data.action === 'play' ? 'â–¶ï¸' : 'â¸ï¸'}`);
                        syncVideoState(data);
                    }
                    break;

                case 'seek':
                    if (data.username !== username) {
                        showSyncIndicator(`${data.username} â© ${Math.floor(data.time)}s`);
                        isSyncing = true;
                        video.currentTime = data.time;
                        setTimeout(() => isSyncing = false, 500);
                    }
                    break;

                case 'chat':
                    addChatMessage(data.username, data.message);
                    break;

                case 'user-joined':
                    addSystemMessage(`${data.username} Ø§Ù†Ø¶Ù… ğŸ‘‹`);
                    updateUserCount(data.userCount);
                    break;

                case 'user-left':
                    addSystemMessage(`${data.username} ØºØ§Ø¯Ø± ğŸ‘‹`);
                    updateUserCount(data.userCount);
                    break;
            }
        }

        function syncVideoState(data) {
            isSyncing = true;
            const timeDiff = Math.abs(video.currentTime - data.time);
            if (timeDiff > 2) video.currentTime = data.time;

            if (data.action === 'play' && video.paused) {
                video.play().catch(e => console.log('Autoplay blocked:', e));
            } else if (data.action === 'pause' && !video.paused) {
                video.pause();
            }
            setTimeout(() => isSyncing = false, 500);
        }

        function showSyncIndicator(message) {
            syncIndicator.textContent = message;
            syncIndicator.style.display = 'block';
            setTimeout(() => syncIndicator.style.display = 'none', 1500);
        }

        // --- Video Events ---
        video.addEventListener('play', () => {
            if (!isSyncing && isConnected) ws.send(JSON.stringify({ type: 'sync', action: 'play', time: video.currentTime }));
        });
        video.addEventListener('pause', () => {
            if (!isSyncing && isConnected) ws.send(JSON.stringify({ type: 'sync', action: 'pause', time: video.currentTime }));
        });
        video.addEventListener('seeked', () => {
            if (!isSyncing && isConnected) ws.send(JSON.stringify({ type: 'seek', time: video.currentTime }));
        });

        // --- Chat & Utils ---
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (message && isConnected) {
                ws.send(JSON.stringify({ type: 'chat', message }));
                addChatMessage(username + ' (Ø£Ù†Øª)', message, true);
                input.value = '';
            }
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        function addChatMessage(user, message, isOwn = false) {
            const div = document.createElement('div');
            div.className = `chat-message ${isOwn ? 'own-message' : ''}`;
            div.innerHTML = `<span class="message-user">${user}:</span><span class="message-text">${escapeHtml(message)}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(message) {
            const div = document.createElement('div');
            div.className = 'chat-message system-message';
            div.innerHTML = `<span class="message-text">${message}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function updateUserCount(count) {
            document.getElementById('userCount').textContent = count;
        }

        function copyRoomLink() {
            navigator.clipboard.writeText(window.location.href).then(() => alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®! ğŸ“‹'));
        }

        function leaveRoom() {
            if (confirm('ØªØºØ§Ø¯Ø±ØŸ')) {
                ws.close();
                window.location.href = 'index.html';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        connectWebSocket();
    </script>
</body>

</html>