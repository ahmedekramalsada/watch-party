trigger: none

parameters:
  - name: videoUrl
    displayName: "Direct Link to Video (MP4/MKV)"
    type: string
    default: ""

pool:
  vmImage: "ubuntu-latest"

jobs:
  - job: UpdateMovie
    displayName: "Download and Convert Movie"
    steps:
      - checkout: self
        persistCredentials: "true"
        fetchDepth: "1"

      - task: Bash@3
        displayName: "Install FFmpeg"
        inputs:
          targetType: "inline"
          script: |
            sudo apt-get update
            sudo apt-get install -y ffmpeg

      - task: Bash@3
        displayName: "Download and Convert"
        env:
          VIDEO_URL: ${{ parameters.videoUrl }}
        inputs:
          targetType: "inline"
          script: |
            set -e  # Fail on any error

            # Download
            echo "Downloading video from $VIDEO_URL..."
            # Ensure media directory exists
            mkdir -p media

            # -f fails on HTTP errors
            # -g disables globbing
            # -L follows redirects
            # -k allows insecure SSL (for some file hosts)
            # --retry 5 retries on transient errors
            # -H User-Agent mimics browser
            curl -f -g -L -k --retry 5 --retry-delay 5 --connect-timeout 60 -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" -o media/movie.mp4 "$VIDEO_URL"

            # Check if file is valid
            if [ ! -s media/movie.mp4 ]; then
              echo "Error: Downloaded file is empty or failed."
              exit 1
            fi

            # Check if it's actually a video (and not an HTML error page)
            FILE_TYPE=$(file --mime-type -b media/movie.mp4)
            echo "Downloaded file type: $FILE_TYPE"
            if [[ "$FILE_TYPE" == "text/html"* ]] || [[ "$FILE_TYPE" == "text/plain"* ]]; then
               echo "‚ùå Error: The link returned a Text/HTML page instead of a video file."
               echo "This usually means it's not a 'Direct Link'. Please make sure the link ends with .mp4 or triggers a download directly."
               echo "File content preview:"
               head -n 10 media/movie.mp4
               exit 1
            fi

            # Convert
            echo "Converting to HLS..."
            cd media
            ffmpeg -i movie.mp4 -c:v libx264 -c:a aac -f hls -hls_time 10 -hls_list_size 0 -hls_segment_filename "movie_%03d.ts" movie.m3u8 || { echo "FFmpeg failed"; exit 1; }

            # Remove source to save space
            rm movie.mp4

      - task: Bash@3
        displayName: "Commit and Push"
        inputs:
          targetType: "inline"
          script: |
            git config --global user.email "azure-pipeline@watchparty.local"
            git config --global user.name "Watch Party Bot"

            git add media/
            git commit -m "Update movie via Azure Pipeline" || echo "No changes to commit"

            git push origin HEAD:$(Build.SourceBranchName)
